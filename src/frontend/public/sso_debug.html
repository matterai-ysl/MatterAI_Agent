<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSOå‚æ•°è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        button {
            background: #007cba;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <h1>ğŸ” SSOå‚æ•°è°ƒè¯•é¡µé¢</h1>

    <div class="debug-info">
        <h3>ğŸ“‹ å½“å‰é¡µé¢ä¿¡æ¯</h3>
        <div id="page-info"></div>
    </div>

    <div class="debug-info">
        <h3>ğŸ” URLå‚æ•°æ£€æŸ¥</h3>
        <div id="url-params"></div>
    </div>

    <div class="debug-info">
        <h3>ğŸ’¾ localStorageæ£€æŸ¥</h3>
        <div id="localstorage-info"></div>
    </div>

    <div>
        <button onclick="refreshInfo()">ğŸ”„ åˆ·æ–°ä¿¡æ¯</button>
        <button onclick="clearStorage()">ğŸ§¹ æ¸…ç©ºlocalStorage</button>
        <button onclick="testSSO()">ğŸ§ª æ¨¡æ‹ŸSSOå¤„ç†</button>
    </div>

    <script>
        function refreshInfo() {
            // é¡µé¢ä¿¡æ¯
            const pageInfo = document.getElementById('page-info');
            pageInfo.innerHTML = `
                <strong>å®Œæ•´URL:</strong> ${window.location.href}<br>
                <strong>åŸŸå:</strong> ${window.location.hostname}<br>
                <strong>è·¯å¾„:</strong> ${window.location.pathname}<br>
                <strong>æŸ¥è¯¢å­—ç¬¦ä¸²:</strong> ${window.location.search}<br>
                <strong>æ—¶é—´:</strong> ${new Date().toLocaleString()}
            `;

            // URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const paramsDiv = document.getElementById('url-params');

            const ssoToken = urlParams.get('sso_token');
            const isSso = urlParams.get('sso');

            let paramsHtml = '';
            if (urlParams.toString()) {
                paramsHtml += '<strong>æ‰€æœ‰å‚æ•°:</strong><br>';
                for (const [key, value] of urlParams.entries()) {
                    paramsHtml += `${key}: ${key.includes('token') ? value.substring(0, 20) + '...' : value}<br>`;
                }
                paramsHtml += '<br>';
            }

            if (ssoToken && isSso === 'true') {
                paramsHtml += `<div class="success">
                    âœ… æ£€æµ‹åˆ°SSOå‚æ•°!<br>
                    sso_token: ${ssoToken.substring(0, 30)}...<br>
                    sso: ${isSso}<br>
                    tokené•¿åº¦: ${ssoToken.length}
                </div>`;
            } else if (ssoToken || isSso) {
                paramsHtml += `<div class="warning">
                    âš ï¸ éƒ¨åˆ†SSOå‚æ•°å­˜åœ¨<br>
                    sso_token: ${ssoToken ? ssoToken.substring(0, 30) + '...' : 'âŒ ç¼ºå¤±'}<br>
                    sso: ${isSso || 'âŒ ç¼ºå¤±'}
                </div>`;
            } else {
                paramsHtml += `<div class="error">
                    âŒ æœªæ£€æµ‹åˆ°SSOå‚æ•°<br>
                    éœ€è¦: sso_token å’Œ sso=true
                </div>`;
            }

            paramsDiv.innerHTML = paramsHtml;

            // localStorageæ£€æŸ¥
            const storageDiv = document.getElementById('localstorage-info');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            let storageHtml = '';
            if (token) {
                storageHtml += `<strong>token:</strong> ${token.substring(0, 30)}...<br>`;
            } else {
                storageHtml += '<strong>token:</strong> âŒ ä¸å­˜åœ¨<br>';
            }

            if (user) {
                try {
                    const userObj = JSON.parse(user);
                    storageHtml += `<strong>user:</strong> ${userObj.name} (${userObj.email})<br>`;
                } catch (e) {
                    storageHtml += `<strong>user:</strong> âš ï¸ è§£æå¤±è´¥<br>`;
                }
            } else {
                storageHtml += '<strong>user:</strong> âŒ ä¸å­˜åœ¨<br>';
            }

            storageDiv.innerHTML = storageHtml;
        }

        function clearStorage() {
            localStorage.clear();
            console.log('localStorageå·²æ¸…ç©º');
            refreshInfo();
        }

        function testSSO() {
            const urlParams = new URLSearchParams(window.location.search);
            const ssoToken = urlParams.get('sso_token');
            const isSso = urlParams.get('sso');

            console.log('ğŸ§ª å¼€å§‹æ¨¡æ‹ŸSSOå¤„ç†...');
            console.log('sso_token:', ssoToken ? ssoToken.substring(0, 20) + '...' : 'null');
            console.log('sso:', isSso);

            if (ssoToken && isSso === 'true') {
                console.log('âœ… å‚æ•°æœ‰æ•ˆï¼Œæ¨¡æ‹Ÿè°ƒç”¨SSO API...');

                // æ¨¡æ‹ŸAPIè°ƒç”¨
                fetch('/agent/api/auth/sso/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sso_token: ssoToken }),
                })
                .then(response => {
                    console.log('APIå“åº”çŠ¶æ€:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('âœ… APIå“åº”æˆåŠŸ:', data);

                    // æ¨¡æ‹Ÿä¿å­˜åˆ°localStorage
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify({
                        id: data.id,
                        email: data.email,
                        name: data.name,
                        isAdmin: data.isAdmin
                    }));

                    console.log('ğŸ’¾ å·²ä¿å­˜åˆ°localStorage');

                    // æ¸…ç†URLå‚æ•°
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                    console.log('ğŸ§¹ URLå‚æ•°å·²æ¸…ç†');

                    refreshInfo();
                    alert('âœ… SSOå¤„ç†æˆåŠŸï¼');
                })
                .catch(error => {
                    console.error('âŒ APIè°ƒç”¨å¤±è´¥:', error);
                    alert('âŒ SSOå¤„ç†å¤±è´¥: ' + error.message);
                });
            } else {
                alert('âŒ ç¼ºå°‘æœ‰æ•ˆçš„SSOå‚æ•°');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            refreshInfo();

            // æ£€æŸ¥æ˜¯å¦æœ‰SSOå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('sso_token') && urlParams.get('sso') === 'true') {
                console.log('ğŸ” é¡µé¢åŠ è½½æ—¶æ£€æµ‹åˆ°SSOå‚æ•°');
            }
        };
    </script>
</body>
</html>