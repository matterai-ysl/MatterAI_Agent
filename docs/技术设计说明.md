## MatterAI 多智能体系统技术设计说明

版本: 2.0.0
最后更新: 2025-09-02

---

## 架构总览

- **前端技术栈**: React + TypeScript + React Router, Tailwind CSS, Framer Motion, Lucide React, react-markdown + remark-gfm + rehype-highlight + highlight.js
- **后端技术栈**: FastAPI (Python), Google ADK (LlmAgent, Runner, DatabaseSessionService), MCPToolset（StreamableHTTP/SSE）
- **通信协议**: HTTP + SSE（Server-Sent Events）
- **运行端口**: 后端默认 `9000`；前端本地开发由脚手架端口决定
- **架构特点**: **多智能体系统**，支持专门化智能体（如MINDS材料科学智能体）
- **核心理念**: 以"会话"为中心的对话引擎，前端流式渲染，后端事件存储、工具编排与HTML报告分屏展示

---

## 功能要点

- **多智能体系统**: 
  - **路由分离**: 默认智能体 (`/`) 和 MINDS 智能体 (`/minds`) 
  - **组件复用**: 共享核心聊天组件（Sidebar, MessageList, ChatInput, useChat）
  - **专门化界面**: 每个智能体拥有独特的欢迎页和交互方式
- **现代化UI**: ChatGPT/Claude风格，深浅色主题、统一圆角与轻阴影
- **侧边栏**: 可折叠、会话分组与排序（按最后消息时间倒序）、移动端覆盖样式
- **欢迎页**: 
  - **默认智能体**: 品牌语"**Matter AI，你可靠的科研伙伴**"，材料科学领域示例卡片
  - **MINDS智能体**: 模块化选择界面，支持多选专业模块（Active Learning, SHAP Analysis等）
- **Markdown**: 支持表格、列表、代码块与语法高亮
- **工具选择器**: 预设+自定义工具（可多选），发送消息后自动折叠；新增自定义工具默认选中
- **工具执行展示**: 解析 `*_html_path` 与 `*_url`，点击或展开时自动右侧分屏显示报告并高亮对应工具项
- **HTML 分屏**: 本地文件通过后端 `/html-content` 返回文本并以 `iframe srcDoc` 安全渲染；`http(s)` 直连用 `iframe src`
- **响应式与可访问性**: 触屏友好、键盘导航基础支持

---

## 前端实现细节（`src/frontend`）

### 主要组件与职责

- `src/index.tsx`（路由配置）
  - **多智能体路由**: React Router配置，支持 `/`（默认）和 `/minds`（MINDS智能体）
  - 路由回退处理，无效路由重定向到默认页面

- `src/NewApp.tsx`（默认智能体）
  - 布局框架：侧边栏 + 主聊天区 + 顶部栏 + 输入区
  - 欢迎页：减少遮挡，固定卡片底部间距，品牌语与示例卡片（材料领域）
  - 集成工具选择器：根据展开/折叠动态为卡片容器添加 `pb-20` / `pb-4` 与 `transition-all duration-200`
  - 分屏 `HtmlViewer` 控制：当工具存在HTML内容且工具项展开时自动打开分屏

- **`src/components/minds/`（MINDS智能体组件）**
  - `MindsApp.tsx`: MINDS智能体主容器，管理模块选择状态和会话切换
  - `MindsWelcome.tsx`: MINDS欢迎页，展示水平排列的模块选择芯片，支持多选
  - `MindsChat.tsx`: MINDS聊天界面，顶部显示选中模块，可动态切换模块

- `components/chat/NewChatInput.tsx`
  - 输入框、发送按钮（加载态）、文件上传提示、工具选择器集成
  - 发送后触发工具选择器折叠（`shouldCollapse`）
  - 将当前选中的自定义工具透传给上层 `onSendMessage`

- `components/tools/ToolSelector.tsx`
  - 展示预设与自定义工具；支持新增/编辑/删除自定义工具
  - 新增自定义工具默认 `enabled: true` 且自动加入选中集合
  - 底部新增“添加自定义工具”按钮；工具栏可折叠，背景 `bg-background/95 backdrop-blur-sm`
  - 回调 `onToolsChange(selectedTools, customTools)`：上抛所选工具ID与自定义工具数组

- `components/tools/ToolItem.tsx`
  - 单个工具项，支持图标/名称/描述/复选框选择，编辑/删除动作（自定义工具）
  - 容错：`tool.name`/`tool.description` 允许为空（UI安全回退）

- `components/chat/ToolDisplay.tsx`
  - 折叠列表展示工具调用与结果
  - 解析 `*_html_path` 与 `*_url`，分别展示“查看HTML（本地）/查看HTML（URL）”按钮
  - 当工具项展开并检测到HTML内容时，自动触发右侧分屏显示并高亮该工具项

- `components/viewer/HtmlViewer.tsx`
  - 判断是否为 `http(s)` URL：
    - `http(s)`：直接设置 `iframe.src`
    - 本地路径：请求后端 `GET /html-content?file_path=...` 获取文本，用 `iframe.srcDoc`
  - 刷新与新窗口打开：
    - 本地路径：使用 Blob URL 在新窗口打开
    - `http(s)`：直接使用原始URL

- `components/chat/MessageList.tsx`（或新版本）
  - 使用 `ReactMarkdown` + `remark-gfm` + `rehype-highlight` 渲染Markdown与代码高亮
  - 滚动优化：仅在“接近底部”时自动滚动，避免流式抖动；必要时禁用列表项动画

### 自定义 Hook

- `hooks/useChat.ts`（核心聊天状态管理）
  - 管理会话、消息、标题、时间戳与SSE事件
  - **多智能体支持**: `sendMessage` 新增 `app_name` 参数支持不同智能体
  - `sendMessage({ text, files, selectedTools, customTools, app_name })`：
    - 自定义工具字段映射：前端 `{ mcpUrl, transportType }` → 后端 `{ url, transport }`
    - 发起 SSE：`chatApiService.startStreamingChat`
  - SSE 事件类型：`meta`（会话ID）、`delta`（增量文本）、`tool_call`、`tool_result`、`done`、`error`

### 样式与动画

- Tailwind CSS 统一风格（变量：颜色/边框/圆角/阴影）
- Framer Motion：折叠/过渡动画（避免流式抖动时的布局跳动）
- 布局自适应：工具选择器显隐影响卡片底部间距（`pb-20`/`pb-4`）

---

## 后端实现细节（`src/backend/main.py`）

### 关键依赖

- Google ADK：`LlmAgent`、`Runner`、`DatabaseSessionService`、`RunConfig`、`StreamingMode`
- MCPToolset：`StreamableHTTPServerParams`、`SseConnectionParams`
- FastAPI：路由、生命周期 `lifespan`、CORS、中间件

### 数据模型（Pydantic）

- `CustomToolConfig`：`{ url: string; transport: string }`
- `ChatRequest`：`{ user_id: string; query: string; session_id?: string; selected_tools?: string[]; custom_tools?: CustomToolConfig[]; app_name?: string }`（新增app_name支持多智能体）

### 路由清单

- `GET /health`：健康检查
- `GET /sessions?user_id`：列出用户的会话ID
- `GET /history?user_id&session_id`：按事件整合为规范化消息（user/assistant，合并工具调用与结果）
- `POST /chat/stream`：SSE流式对话
  - 创建/获取会话ID并首发 `meta { session_id }`
  - 按需创建或复用“会话级智能体”（见下）
  - 将 ADK `runner.run_async(...)` 的事件转为前端消费的SSE消息
- `GET /html-content?file_path=...`：读取本地HTML文本返回，前端以 `srcDoc` 渲染
- `POST /upload`：上传文件，返回可访问URL（静态目录 `/uploads`）
- `POST /cleanup`：手动触发过期会话清理
- `GET /cache-status`：查看缓存与会话空闲时间

### 动态智能体与工具装配

- **多智能体配置**位于 `src/backend/Config.py`：
  - `PRESET_TOOLS_CONFIG`：默认智能体工具（Material Knowledge, XGBoost等）
  - `MINDS_TOOLS_CONFIG`：MINDS智能体专用工具（Active Learning, SHAP Analysis等）
  - `AGENT_CONFIGS`：智能体配置映射，按app_name区分不同智能体
- `create_mcp_tool_from_config(tool_config)`：
  - `transport == 'http'` → `StreamableHTTPServerParams`
  - `transport == 'sse'` → `SseConnectionParams`
  - 超时策略：`timeout=10`, `sse_read_timeout=300`, `terminate_on_close=True`
- `create_dynamic_agent(selected_tools, custom_tools, app_name)`：
  - 根据app_name选择对应的工具配置集合
  - `preset-*`：从对应智能体的工具配置按ID加载
  - `custom-*`：按其在 `selected_tools` 的顺序与 `custom_tools` 对齐（索引推断）
  - 指令集：根据智能体类型定制（默认/MINDS材料科学专门化）

### 会话级智能体缓存（多用户隔离）

- 全局缓存：
  - `session_agents: Dict[str, Runner]`（键：`"user_id:session_id"`）
  - `session_agent_configs: Dict[str, Any]`（工具配置签名，用于复用判断）
  - `session_last_access: Dict[str, float]`（最近访问时间）
  - `active_sessions: set`（正在处理中的会话ID，清理时跳过）
- 获取/创建：`get_or_create_session_agent(user_id, session_id, selected_tools, custom_tools)`
  - 生成配置签名：`(sorted(selected_tools), [(url, transport), ...])`
  - 一致→复用Runner；变更→关闭旧Runner并创建新Runner
- 清理策略：
  - 对话结束仅关闭“无会话ID的临时Runner”；会话级Runner常驻缓存
  - 应用关闭：关闭全部缓存Runner并清空缓存
  - 定期清理任务：默认每10分钟检查一次，空闲达30分钟回收（可手动 `/cleanup`）

### SSE 事件映射

- `meta`：`{ session_id }`（首发）
- `delta`：增量文本（partial/完整合并逻辑）
- `tool_call`：`{ name, args }`
- `tool_result`：`{ name, result }`
- `done`：对话轮次完成
- `error`：异常信息

### 稳定性与错误修复

- 修复 `RuntimeError: Attempted to exit cancel scope ...`：
  - 不在SSE TaskGroup外部关闭其内部资源
  - 仅关闭“临时Runner”，会话级Runner交由缓存与定期清理处理
- 自定义工具字段对齐：前端 `{ mcpUrl, transportType }` → 后端 `{ url, transport }`
- 端口一致性：前端访问 `http://localhost:9000` 的后端

---

## 数据结构与类型（节选）

- 前端 `src/frontend/src/types/chat.ts`
  - `ChatRequest`、`SSEEvent`、`ToolCall`、`ToolResult` 等
- 后端 `main.py`
  - `CustomToolConfig`、`ChatRequest`

---

## 端到端数据流

1. 前端输入消息并选择工具（可选）
2. `useChat.sendMessage` 映射自定义工具字段，发起 `POST /chat/stream`（SSE）
3. 后端创建/复用会话级Runner并开始 `runner.run_async`
4. 后端把事件流转为SSE：`meta` → 多个 `delta`/`tool_call`/`tool_result` → `done`
5. 前端流式渲染Markdown；工具展开时自动分屏展示 `*_html_path`/`*_url`
6. 会话结束：前端停止自动滚动；后端仅在“临时Runner”情况下关闭实例
7. 定期清理与手动清理保障长期运行稳定

---

## 扩展与复用建议

### 新增智能体（推荐流程）

1. **后端配置**（`src/backend/Config.py`）：
   - 创建新的工具配置字典（如 `NEW_AGENT_TOOLS_CONFIG`）
   - 在 `AGENT_CONFIGS` 中添加新智能体配置
   - 定义智能体名称、工具集合和系统提示词

2. **前端实现**（组件复用策略）：
   - **复用核心组件**：`Sidebar`, `MessageList`, `ChatInput`, `useChat` Hook
   - **新建专门组件**：在 `src/components/[agent-name]/` 创建：
     - `[AgentName]App.tsx`：主容器组件
     - `[AgentName]Welcome.tsx`：欢迎页面（自定义交互方式）
     - `[AgentName]Chat.tsx`：聊天界面（可选，如需特殊功能）

3. **路由配置**（`src/index.tsx`）：
   - 添加新路由 `/agent-name`
   - 导入并配置新智能体组件

### 其他扩展建议

- **新增预设工具**：更新对应智能体的工具配置，并在前端增加选择项
- **HTML 报告**：建议MCP服务对外暴露URL并允许跨域；否则走 `/html-content`
- **性能优化**：长列表虚拟化、消息分段渲染、工具结果懒加载

---

## 本地开发与运行

- **后端**：`cd src/backend && python main.py`（端口 `9000`）
- **前端**：`cd src/frontend && npm install && npm run dev`
- **环境变量**：`OPENAI_API_KEY`、`BASE_URL`、`DB_HOST/DB_NAME/DB_USER/DB_PASSWORD`

---

## 已知问题与建议

- 超长Markdown建议分段或分页呈现，避免滚动抖动
- MCP服务异常时建议重试与超时兜底，并监控清理任务
- 建议为缓存状态、会话并发、清理次数等增加监控指标

---

## 变更日志（关键）

### v2.0.0 - 多智能体架构 (2025-09-02)
- **多智能体系统**: 引入app_name区分不同智能体，支持专门化智能体
- **MINDS智能体**: 实现材料科学专门智能体，包含4个专业模块
  - 模块选择界面：水平排列的选择芯片，支持多选
  - 专门工具配置：Active Learning, SHAP Analysis, Neural Network, LLM-RAG
  - 组件复用设计：复用核心聊天组件，降低开发成本
- **React Router**: 前端路由支持，`/`（默认）和`/minds`（MINDS智能体）
- **后端扩展**: `AGENT_CONFIGS`智能体配置字典，动态智能体创建支持app_name

### v1.0.0 - 基础功能 (之前版本)
- 支持 Markdown 与代码高亮
- 工具选择器交互增强：发送后折叠、底部新增按钮、新增工具默认选中
- 分屏HTML：识别 `*_html_path`/`*_url`，工具展开自动分屏
- 多用户隔离：缓存键改为 `user_id:session_id`
- 会话级智能体缓存：复用相同配置；配置变化则替换
- 定期清理：每10分钟检查，空闲30分钟回收
- 修复异步 `cancel scope`：仅清理临时Runner
